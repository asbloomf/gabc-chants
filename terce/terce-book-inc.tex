% !TEX TS-program = lualatex
% !TEX encoding = UTF-8

% This is a simple template for a LuaLaTeX document using gregorio scores.

% easter can be from march 22 to april 25

\usepackage{../definepsalms}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{titleps}
\usepackage{letltxmacro}
\usepackage{changepage} % gives us \ifoddpage use [strict]
\usepackage[super]{nth}
\usepackage[savepos]{zref}
\usepackage{xparse}
\usepackage{setspace}
\usepackage{amsfonts}
\usepackage{refcount}
\usepackage{metalogo}
\usepackage{enumitem}
\usepackage{zref-titleref}
\makeatletter
\newcommand*{\currentname}{\zref@getcurrent{title}}
% or \newcommand*{\currentname}{\zref@titleref@current}
\makeatother
%\nofiles
%\includeonly{inc-grassi}
\LetLtxMacro{\oldnth}{\nth}
\renewcommand{\nth}[1]{{\addfontfeature{Numbers=Lining}\oldnth{#1}}}
\LetLtxMacro{\oldneedspace}{\needspace}
\renewcommand{\needspace}[1]{
	\checkoddpage\ifoddpage\oldneedspace{#1}\else\fi
}
\let\gredagger=\dag
\newcommand*\cleartoleftpage{%
  \clearpage
  \ifodd\value{page}\hbox{}\newpage\fi
}
\hyphenation{GregoBase}

%\usepackage{hyperref}
\ifx\phantomsection\undefined%
	\newcommand{\phantomsection}{}
\fi

\setcounter{secnumdepth}{-1}

\ifthenelse{\boolean{lettersize}}{
	\def\mywidth{8.5in}
	\def\myheight{11in}
}{
	\def\mywidth{6in}
	\def\myheight{9in}
}

\input{../inc_header}
\gresetbarspacing{new}
%\gresetlastline{justified}
\setlength\headheight{0.25in+15pt}
\setlength\headsep{1pc}
\setlength\topskip{0pc}
\setlength\footskip{1pc}
\geometry{outer=0.4in,inner=0.85in,top=0pc+\headheight+\headsep,bottom=0.4in,twoside=true}
\newpagestyle{main}{
%\setheadrule{0pt}
\sethead[\garamond{\thepage}][\garamond{\chaptertitle}][] % even
{}{\garamond{\sectiontitle}}{\garamond{\thepage}} % odd
\setfoot[][][] % even
{}{}{} % odd
}
\pagestyle{main}

%\grechangeglyph{Porrectus*}{*}{.alt}
%\grechangeglyph{TorculusResupinus*}{*}{.alt}

\titleformat
{\section} % command
[block] % shape
{\phantomsection\large\addfontfeature{Numbers=Lining}} % format
{} % label
{} % sep
{
    % \rule{\textwidth}{1pt}
    % \vspace{1ex}
    \centering
} % before-code
%[
% \vspace{-0.5ex}%
% \rule{\textwidth}{0.3pt}
%] % after-code
 
 
\titleformat{\chapter}[block]
{\thispagestyle{empty}\phantomsection\Large\scshape\addfontfeature{Numbers=Lining}}
{}{0.5em}{\centering}
 
\titlespacing{\chapter}{0pt}{6pt-\headheight}{1pc}
\titlespacing{\section}{0pt}{*2.5}{*1}
\titleclass{\chapter}{top}
\newcommand{\chapterbreak}{\clearpage}
%\titleclass{\section}{top}

\contentsmargin{2pc}
%\dottedcontents{chapter}[2.3em]{}{2.3em}{1pc}
\titlecontents{chapter}[2.3em]{}{\contentslabel{2.3em}}{\hspace*{-2.3em}}{}
\dottedcontents{section}[5.5em]{}{3.2em}{1pc}

\newcommand{\printnote}[1]{
	{\normalsize \emph{#1}}%
}
\newcommand{\subtitle}[1]{
{
	\centering
	{\addfontfeature{Numbers=Lining} \normalsize \emph{#1}}\par
}
}
\makeatletter  
\newcounter{score}
\newcounter{tabstop}[score]
\newcommand{\grealign}{%
  \@bsphack%
  \ifgre@boxing\else%
    \kern\gre@dimen@begindifference%
    \stepcounter{tabstop}%
    \expandafter\zsavepos{stop-\thescore-\thetabstop}%
    \kern-\gre@dimen@begindifference%
  \fi%
  \@esphack%
}
\newcommand{\setstops}{%
  \gdef\nstabbing@stops{%
    \checkoddpage
    \hspace*{-\ifoddpage\oddsidemargin\else\evensidemargin\fi}\hspace{-1in}%
    \hspace*{\zposx{stop-\thescore-1} sp}\=%
  }%
  \count@=\@ne
  \loop\ifnum\count@<\value{tabstop}%
    \begingroup\edef\x{\endgroup
      \noexpand\g@addto@macro\noexpand\nstabbing@stops{%
        \noexpand\hspace{-\noexpand\zposx{stop-\thescore-\the\count@} sp}%
        \noexpand\hspace{\noexpand\zposx{stop-\thescore-\the\numexpr\count@+1} sp}\noexpand\=%
      }%
    }\x
    \advance\count@\@ne
  \repeat
  \nstabbing@stops\kill
}
\makeatother

\newenvironment{nstabbing}
  {\setlength{\topsep}{0pt}%
   \setlength{\partopsep}{0pt}%
   \tabbing%
   \setstops}
  {\endtabbing\stepcounter{score}}

\def\beginpsalmcols{\begin{parcolumns}[rulebetween]{2}}
\def\endpsalmcols{\end{parcolumns}}

\newcommand{\deusinadjutorium}{\noindent{\Vbar~Deus in adjutórium, p.~\pageref{deusinadjutorium}}}
%\newcommand{\deusinadjutoriumsolemn}{\noindent\printnote{\Vbar~\emph{Deus in adjutórium}, p.~\pageref{deusinadjutoriumsolemn}.}}
\newcommand{\printcollect}[2]{
	\ifx\undefined\begincollectcols\def\begincollectcols{\begin{parcolumns}[rulebetween]{2}}\fi
	\ifx\printcollectheading\undefined\def\printcollectheading{T}\fi
	\if\printcollectheading T
		\oldneedspace{36pt}
		%\penalty -100% this is to try to replace the oldneedspace
		\medskip
		{\centering\large Collect.\par}
		%\smallskip
	\fi
	\ifx\precollect\undefined\else\precollect\fi
	\begincollectcols
	\sloppy
	\prayer{#1}{#2}
	\end{parcolumns}
	\let\begincollectcols=\undefined
}
\newcommand{\benedicamusdominoreference}[1]{%
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		\Vbar~\emph{Benedicámus Dómino \IfInteger{#1}{#1}{\csname benedicamusdominoname#1\endcsname}}, p.~\pageref{benedicamusdomino-#1}.
	}{}
}
\newcommand{\benedicamusdominoreferencelentoreaster}{%
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		In Lent, \Vbar~\emph{Benedicámus Dómino \benedicamusdominonamelent}, p.~\pageref{benedicamusdomino-lent}, or in Easter, \emph{\benedicamusdominonameeaster}, page \pageref{benedicamusdomino-easter}.
	}{}
}
\newcommand{\benedicamusdominomaster}[1]{
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		\noindent\printnote{\benedicamusdominoreference{#1}}
		\ifx\postbenedicamusdomino\undefined\else\postbenedicamusdomino\fi
	}{}
	\bigskip
	\hrule
}
\newcommand{\benedicamusdominolentoreaster}{
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		\noindent\printnote{\benedicamusdominoreferencelentoreaster}
		\ifx\postbenedicamusdomino\undefined\else\postbenedicamusdomino\fi
	}{}
	\bigskip
	\hrule
}

\ifthenelse{\boolean{lettersize}}{
	\newcommand{\psalmcolsoverride}[1][0]{
	}	
}{
	\newcommand{\psalmcolsoverride}[1][0]{
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.45\linewidth}]{2}}
		\ifnum#1=110
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth}]{2}}
		\fi
		\ifnum#1=111
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
		\fi
		%\ifnum#1=112
		%\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.445\linewidth}]{2}}
		%\fi
		\ifnum#1=116
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.5655\linewidth}]{2}}
		\fi
		\ifnum#1=121
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.47\linewidth}]{2}}
		\fi
		\ifnum#1=125
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.49\linewidth}]{2}}
		\fi
		\ifnum#1=129
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
		\fi
		\ifnum#1=131
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.4875\linewidth},distance=1em]{2}}
		\fi
		\ifnum#1=137
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween]{2}}
		\fi
		\ifnum#1=147
		%\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth}]{2}}
		\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
		\fi
	}
}
\DeclareDocumentCommand{\printbothversions}{ O{\undefined} O{\undefined} m m }{
% #1 & #2 are the label
% #3 is what to check for
% #4 is the body of what to print
	\ifx#3\undefined
		\ifx\definevesperspropersalt\undefined\else
	  {
			\ifx\vesperspropersaltnote\undefined\else
		    \oldneedspace{3\baselineskip}
				\printnote{\vesperspropersaltnote}
			\fi
			\definevesperspropersalt
			\ifx#2\undefined\else\oldneedspace{5\baselineskip}\label{#2}\fi
	  	#4
		}
		\medskip
		\fi
		\ifx\definevesperspropers\undefined\else
	  {
			\ifx\vesperspropersnote\undefined\else
	    	\oldneedspace{3\baselineskip}
				\printnote{\vesperspropersnote}
			\fi
			\definevesperspropers
			\ifx#1\undefined\else\oldneedspace{5\baselineskip}\label{#1}\fi
	  	#4
		}
		\fi
	\else
  {
		\ifx#1\undefined\else\label{#1}\fi
  	#4
	}
	\fi
}
\let\printhymn=\undefined
\newcommand{\printpsalmtitle}[1]{%
  {\addfontfeature{Numbers=Lining}\centering Psalm #1\\}%
}
\newcommand{\printtercepsalms}[1]{
  % #1 is psalm tone like 2D
  \printpsalmtitle{118. III.}

  %print first verse in chant
  {
    \gresetinitiallines{0}
    \grechangedim{interwordspacetext}{0.15 cm plus 0.15 cm minus 0.10 cm}{scalable}%
    \gregorioscore{psalms/Psalm118.3-#1}
    \input{../gsp-spaces}
    \greseteolcustos{auto}
  }
  \vspace{0pt plus 4pt minus 8pt}
  \setlength\parsep{0pt}%
  \setlength\topsep{0pt}%
  \setlength\partopsep{0pt}%
  \setlength\multicolsep{0pt}%
  \setlength{\columnsep}{18pt}
  \setlength{\columnseprule}{.4pt}
  \selectlanguage{latin}
  \begin{multicols}{2}
  \begin{psalmverses}[1]
  \input{psalms/Psalm118.3-#1-verses}
  \end{psalmverses}
  %\medskip
  \printpsalmtitle{118. IV.}
  \begin{psalmverses}
  \input{psalms/Psalm118.4-#1-verses}
  \end{psalmverses}
  %\medskip
  \printpsalmtitle{118. V.}
  \begin{psalmverses}
  \input{psalms/Psalm118.5-#1-verses}
  \end{psalmverses}
  \setlength{\parindent}{6ex}
  \ifx\printrepeatantiphon\undefined
	  \IfStrEq{#1}{no-tone}{}{%if not no-tone

	    \emph{Repeat antiphon.}%
	  }
	\else

		\printrepeatantiphon
	\fi
  \end{multicols}
}
\newcommand{\printtercepsalmstranslation}{
  \setlength\parsep{0pt}%
  \setlength\topsep{0pt}%
  \setlength\partopsep{0pt}%
  \setlength\multicolsep{0pt}%
  \setlength{\columnsep}{18pt}
  \setlength{\columnseprule}{.4pt}
  \selectlanguage{american}
  \begin{multicols}{2}
  \printpsalmtitle{118. III.}
  \begin{psalmverses}
  \emph{\input{psalms/Psalm118.3-verses-en}}
  \end{psalmverses}
  \medskip
  \printpsalmtitle{118. IV.}
  \begin{psalmverses}
  \emph{\input{psalms/Psalm118.4-verses-en}}
  \end{psalmverses}
  \medskip
  \printpsalmtitle{118. V.}
  \begin{psalmverses}
  \emph{\input{psalms/Psalm118.5-verses-en}}
  \end{psalmverses}
  \end{multicols}
}
\def\printbenedicamusdominoref{%
  \noindent{\Vbar{}~Benedicámus Dómino, p.~\pageref{benedicamus-domino-sunday}.}
}
\def\printhymnsundayrefnospace{%
  \emph{Hymn 1}, p.~\pageref{hymn-sunday}%
}
\def\printhymnsundayref{%
  , \printhymnsundayrefnospace{}.

  \medskip
}
\def\printhymnfeastref{%
  , \emph{Hymn 2}, p.~\pageref{hymn-feast}.

  \medskip
}
\def\printhymnbvmref{%
  , \emph{Hymn 3}, p.~\pageref{hymn-bvm}.

  \medskip
}
\let\printhymn=\printhymnsundayref
\newcommand{\printterce}[3][.]{
	{
		\grechangestaffsize{15}
		\ifx\gabcfolder\undefined
			\def\gabcfolder{#1}
			\input{\gabcfolder/#2}
		\fi

		\deusinadjutorium{}%
		\ifx\printhymn\undefined%
		\else%
		  \printhymn
		\fi

		\ifx\anttwotex\undefined\else%
			\setlabel{#3}{ant}
			\printgabc{Ant.}{\anttwolinetwo}{\anttwoinitial}{\anttwotex .noEuouae}

			\ifx\anttwotranslation\undefined\else%
				\translation[]{\anttwotranslation}
			\fi

			\printtercepsalms{\anttwotoneendexpanded}
		\fi
		\ifx\chaptertext\undefined\else
			\ifx\prechapter\undefined\else%
				\prechapter
			\fi
			\setlabel{#3}{chapter}
			\printchapter{\chaptertext}{\chaptertranslation}

			\medskip
		\fi

		\ifx\printshortresp\undefined%
			\noindent\emph{Short Resp. \emph{Inclina cor meum}}, p. \pageref{shortresp-sunday}, \Vbar{}~Ego dixi, p. \pageref{vr-sunday}.
		\else
			\printshortresp
		\fi

		\ifx\collect\undefined%
			\let\collect=\latincollect
			\let\collecttranslation=\englishcollect
		\fi
		\setlabel{#3}{collect}
		\printcollect{\collect}{\collecttranslation}

		\medskip

		\ifx\printbenedicamusdominoref\undefined\else\printbenedicamusdominoref\fi
	}
}

\sloppy
%\nofiles
\begin{document}
\normalsize
\grechangestaffsize{15}
{
	\thispagestyle{empty}
	% title page
	% general
	\vspace*{5\baselineskip}

	{\centering

	{\Huge
	Terce with Gregorian Chant

	}

	{\Large\medskip
	\emph{for}

	\medskip}

	{\Huge
	Sundays \& Holy Days

	}
	\vfill}
	\pagebreak
	% copyright page
	\thispagestyle{empty}
	\noindent{}Terce with Gregorian Chant for Sundays \& Holy Days: \emph{newly typeset, based on \emph{The Liber Usualis}, edited by the Benedictines of Solesmes (Desclee Company, 1961).}

	\bigskip{}
	\noindent{}%
	Elie Roux's Gregorio (https://gregorio-project.github.io), Olivier Berton's GregoBase (http://gregobase.selapa.net), and my brother Benjamin's chant tools (http://bbloomf.github.io/jgabc) were indispensible in the creation of this book.

	\begin{flushright}
	\emph{Albert Bloomfield}\\
	Cincinnati, Ohio
	\end{flushright}

	\bigskip{}\noindent{}http://asbloomf.github.io/gabc-chants

	\vfill
%editions
	\bigskip{}\noindent{}%
	First edition, 13 July 2021.

	\hangindent=1em % indent all subsequent lines
    \bigskip

\makeatletter
	\noindent{}Typeset using \LuaLaTeX{} and Gregorio version \gre@gregoriotexversion{}
\makeatother

	\bigskip{}\noindent{}This work is free of known copyright restrictions.

	\bigskip{}\noindent{}%CreateSpace
	ISBN: \isbn{}
	%
  %\noindent{}Lulu ISBN: 978-1-329-59990-1
}
%\frontmatter
%\pagenumbering{roman}

\tableofcontents%

%\pagenumbering{arabic}
%\mainmatter

% redefine the  label command
\newcommand{\setlabel}[2]{
% #1 label part 1 (like easter2)
% #2 label part 2 (any of these 3: ant/chapter/collect)
	\label{#1-#2}% now execute the original label command
}

%\include{inc-common-terce}
\ifthenelse{\boolean{testrun}}{
	\input{inc-terce-sunday}

	\input{inc-timeafterpentecost}
	%\input{inc-proper-of-saints}
}{

	\clearpage

	\input{inc-terce-sunday}

	\input{inc-advent}

	\input{inc-christmas}

	\input{inc-timeafterepiphany}

	\input{inc-lent}

	\input{inc-easter}

	\input{inc-pentecost}

	\input{inc-timeafterpentecost}

	\input{inc-proper-of-saints}

	\input{inc-appendix}

}
\end{document}

