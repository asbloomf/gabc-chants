% !TEX TS-program = lualatex
% !TEX encoding = UTF-8

% This is a simple template for a LuaLaTeX document using gregorio scores.

\documentclass[letterpaper,12pt]{book} % use larger type; default would be 10pt
\usepackage{../definepsalms}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{titleps}
\usepackage{letltxmacro}
\usepackage[strict]{changepage} % gives us \ifoddpage

\LetLtxMacro{\oldneedspace}{\needspace}
\renewcommand{\needspace}[1]{
	\checkoddpage\ifoddpage\oldneedspace{#1}\else\fi
}

%\usepackage{hyperref}
\newcommand{\phantomsection}{}
\newcommand{\magnote}{
\IfStrEq{\anttone\nostarend}{8G}{\noindent\emph{A 3 part arrangement of the even verses by Grassi may be found on page \pageref{magnificat-grassi}.\\}}{}
}
\presetkeys{mymag}{note=\magnote}{}
%\LetLtxMacro{\oldprintmag}{\printmag}
%\renewcommand{\printmag}[4][grassilabel=magnificat-grassi]{
%\oldprintmag[#1]{#2}{#3}{#4}
%}

\setcounter{secnumdepth}{-1}

\def\mywidth{6in}
\def\myheight{9in}

\input{../inc_header}
\setlength\headheight{0.25in+15pt}
\setlength\headsep{1pc}
\setlength\topskip{0pc}
\setlength\footskip{1pc}
\geometry{outer=0.4in,inner=0.85in,top=0pc+\headheight+\headsep,bottom=0.4in,twoside=true}
\newpagestyle{main}{
\sethead[\garamond{\thepage}][\garamond{\chaptertitle}][] % even
{}{\garamond{\sectiontitle}}{\garamond{\thepage}} % odd
\setfoot[][][] % even
{}{}{} % odd
}
\pagestyle{main}


\titleformat
{\section} % command
[block] % shape
{\phantomsection\large\addfontfeature{Numbers=Lining}} % format
{} % label
{} % sep
{
    % \rule{\textwidth}{1pt}
    % \vspace{1ex}
    \centering
} % before-code
%[
% \vspace{-0.5ex}%
% \rule{\textwidth}{0.3pt}
%] % after-code
 
 
\titleformat{\chapter}[block]
{\thispagestyle{empty}\phantomsection\Large\scshape\addfontfeature{Numbers=Lining}}
{}{0.5em}{\centering}
 
\titlespacing{\chapter}{0pt}{-\headheight}{1pc}
\titlespacing{\section}{0pt}{*2.5}{*1}
\titleclass{\chapter}{top}
\newcommand{\chapterbreak}{\clearpage}
%\titleclass{\section}{top}

\contentsmargin{1pc}
\dottedcontents{chapter}[0pc]{}{2pc}{1pc}
\dottedcontents{section}[0pc]{}{0pc}{1pc}

\newcommand{\printnote}[1]{
	{\normalsize \emph{#1}}
}
\newcommand{\subtitle}[1]{
\begin{center}{
	{\addfontfeature{Numbers=Lining} \normalsize \emph{#1}}
}\end{center}
}

\newcommand{\deusinadjutorium}{\noindent\printnote{\Vbar~\emph{Deus in adjutórium}, page \pageref{deusinadjutorium}.}}
\newcommand{\printcollect}[2]{
\needspace{3\baselineskip}
\begin{center}{\large Collect.}\end{center}
\vspace{-0.5\baselineskip plus 0.25\baselineskip}
\begin{parcolumns}[rulebetween]{2}
\sloppy
\prayer{#1}{#2}
\end{parcolumns}
}
\newcommand{\psalmcolsoverride}[1][0]{
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.45\linewidth}]{2}}
\ifnum#1=110
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.45\linewidth}]{2}}
\fi
\ifnum#1=111
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
\fi
}
\newcommand{\printcommemoration}[2][.]{
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}
	\subtitle{\comheadingtext}
	\sectionmark{\comheadingtext}

	{
	\def\noeuouae{T}
	\printgabc{At Magn.}{\oldstylenums{\commagantlinetwo}}{\commagantinitial}{\commaganttex}
	}
	\translation[]{\englishcommagantiphon}

	\bigskip
	\printvr[\greblockcustos]{\commvrtex}{\commvtranslation}{\commrtranslation}

	\printcollect{\latincomcollect}{\englishcomcollect}
}
\newcommand{\printvespersmag}[2][.]{
	\setgrefactor{15}
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}

	\ifx\chaptertext\undefined\else{
		\printchapter{\chaptertext}{\chaptertranslation}
		\bigskip
	}\fi

	\printhymnnote

	{
		\let\anttranslation=\englishmagantiphon
		\let\preverses=\premagverses
	    \let\preanttwo=\premagtwo
	    \let\preant=\premag
		\printmag{\magtone\magend}{\magantinitial}{\maganttex}
	}

	\printcollect{\latincollect}{\englishcollect}
}
\newcommand{\printvespers}[2][.]{
	\setgrefactor{15}
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}

	\deusinadjutorium{}
	\bigskip
	\printpsalm{1}{\psalmonenum}{\psalmonetone\psalmoneend}{\antonetex}{\antoneinitial}
	\bigskip
	\printpsalm{2}{\psalmtwonum}{\psalmtwotone\psalmtwoend}{\anttwotex}{\anttwoinitial}
	\bigskip
	\needspace{3\baselineskip}
	\printpsalm{3}{\psalmthreenum}{\psalmthreetone\psalmthreeend}{\antthreetex}{\antthreeinitial}
	\bigskip
	\needspace{3\baselineskip}
	\printpsalm{4}{\psalmfournum}{\psalmfourtone\psalmfourend}{\antfourtex}{\antfourinitial}
	\bigskip
	\ifx\psalmfivenum\undefined{
		\ifx\definevesperspropers\undefined\else{
			\definevesperspropers
			\ifx\vesperspropersnote\undefined\else
				\printnote{\vesperspropersnote}
			\fi
			\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
		}\fi
		\ifx\definevesperspropersalt\undefined\else{
			\definevesperspropersalt
			\ifx\vesperspropersaltnote\undefined\else
				\printnote{\vesperspropersaltnote}
			\fi
			\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
		}\fi
	}\else{
		\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
	}\fi
	\bigskip

	\needspace{3\baselineskip}
	\ifx\chapterreplacement\undefined{
		\ifx\chaptertext\undefined
			\ifx\definevesperspropers\undefined\else
			{
				\ifx\vesperspropersnote\undefined\else
					\printnote{\vesperspropersnote}
				\fi
				\definevesperspropers
				\printchapter{\chaptertext}{\chaptertranslation}
			}
			\fi
			\ifx\definevesperspropersalt\undefined\else
			\bigskip
			{
				\ifx\vesperspropersaltnote\undefined\else
					\printnote{\vesperspropersaltnote}
				\fi
				\definevesperspropersalt
				\printchapter{\chaptertext}{\chaptertranslation}
			}
			\fi
		\else
			\printchapter{\chaptertext}{\chaptertranslation}
		\fi
	}
	\else
	{\chapterreplacement}
	\fi

	\bigskip
	\ifx\printfullhymn\undefined
		\printhymnnote
	\else
		\printfullhymn
	\fi

	\bigskip
	\ifx\magreplacement\undefined
	{
	\ifx\definevesperspropersalt\undefined\else{
		\definevesperspropersalt
	    \begin{center}{\large Magnificat.}\end{center}
    	\vspace{-1ex}
    	\ifx\vesperspropersaltnote\undefined\else
			\printnote{\vesperspropersaltnote\\}
		\fi
		\let\anttranslation=\maganttranslation
		\let\preverses=\premagverses
	    \let\preanttwo=\premagtwo
	    \let\preant=\premag
	    \def\nomagtitle{T}
		\printmag{\magtone\magend}{\magantinitial}{\maganttex}
	}\fi
	\ifx\definevesperspropers\undefined\else
		\definevesperspropers
    	\ifx\vesperspropersnote\undefined\else
			\printnote{\vesperspropersnote\\}
		\fi
		\def\nomagtitle{T}
	\fi
	\let\anttranslation=\maganttranslation
	\let\preverses=\premagverses
    \let\preanttwo=\premagtwo
    \let\preant=\premag
	\printmag{\magtone\magend}{\magantinitial}{\maganttex}
	}
	\else
	{\magreplacement}
	\fi
	{\ifx\postmag\undefined\else\postmag\fi}

	\ifx\collectreplacement\undefined{
		\ifx\collect\undefined
			\ifx\definevesperspropers\undefined\else
			{
				\ifx\vesperspropersnote\undefined\else
					\printnote{\vesperspropersnote}
				\fi
				\definevesperspropers
				\printcollect{\collect}{\collecttranslation}
			}
			\fi
			\ifx\definevesperspropersalt\undefined\else
			\bigskip
			{
				\ifx\vesperspropersaltnote\undefined\else
					\printnote{\vesperspropersaltnote}
				\fi
				\definevesperspropersalt
				\printcollect{\collect}{\collecttranslation}
			}
			\fi
		\else
			\printcollect{\collect}{\collecttranslation}
		\fi
	}
	\else
	{\collectreplacement}
	\fi
	\bigskip
}

\sloppy
\begin{document}
\normalsize
\setgrefactor{15}
%\pagenumbering{roman}
%\frontmatter

\tableofcontents

%\pagenumbering{arabic}
%\mainmatter

\chapter{Common of Festal Vespers}

%\subtitle{Festal Tone}
\label{deusinadjutorium}
\sectionmark{Deus in adjutórium}
\addcontentsline{toc}{section}{Deus in adjutórium}
\printnote{The Festal Tone may be sung on any Sunday or Feast.}

\smallskip
\def\deusinadjutoriumsolemn{F}
\printdeusinadjutorium{}

%\pagebreak
%\subtitle{Solemn Tone}
\printnote{The Solemn Tone may only be sung on Feasts of the First or Second Class.}

\medskip
\def\deusinadjutoriumsolemn{T}
\printdeusinadjutorium{}


\printnote{Vespers then proceed with the Proper Antiphons, Psalms, Chapter, Hymn, Versicle,
Magnificat, and Collect given for the respective Sunday or Feast.}

\medskip

\printnote{All Vespers conclude with the following:}
\\
\Vbar{} Dóminus vobíscum.\\%\hspace{5em}
\Rbar{} Et cum spíritu tuo.

\printnote{Or, in the absence of a priest or deacon:}
\\
\Vbar{} Dómine, exáudi oratiónem meam.\\
\Rbar{} Et clamor meus ad te véniat.

\medskip

%\input{inc-benedicamus-domino}

%\input{inc-marian-anthems}

%this is just an example of using pageref
%See Deus in adjutorium on page \pageref{deusinadjutorium} and Benedicamus domino on page \pageref{benedicamusdomino}.

\def\dontrepeatantiphon{T}
%\input{inc-advent}

% christmas through Holy Family
%\input{inc-christmas}

%\input{inc-timeafterepiphany}

%from shrovetide through passiontide
\input{inc-lent}

\chapter{Appendix}
%\input{inc-benediction}
%\input{inc-grassi}

\end{document}

