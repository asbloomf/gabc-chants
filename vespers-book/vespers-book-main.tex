% !TEX TS-program = lualatex
% !TEX encoding = UTF-8

% This is a simple template for a LuaLaTeX document using gregorio scores.

% easter can be from march 22 to april 25

\documentclass[letterpaper,12pt]{book} % use larger type; default would be 10pt
\usepackage{../definepsalms}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{titleps}
\usepackage{letltxmacro}
\usepackage{changepage} % gives us \ifoddpage use [strict]
\usepackage[super]{nth}
\LetLtxMacro{\oldnth}{\nth}
\renewcommand{\nth}[1]{\addfontfeature{Numbers=Lining}\oldnth{#1}}
\LetLtxMacro{\oldneedspace}{\needspace}
\renewcommand{\needspace}[1]{
	\checkoddpage\ifoddpage\oldneedspace{#1}\else\fi
}
\let\gredagger=\dag

%\usepackage{hyperref}
\newcommand{\phantomsection}{}
\newcommand{\magnote}{
\IfStrEq{\anttone\nostarend}{8G}{\noindent\emph{A 3 part arrangement of the even verses by Grassi may be found on page \pageref{magnificat-grassi}.\\}}{}
}
\presetkeys{mymag}{note=\magnote}{}
%\LetLtxMacro{\oldprintmag}{\printmag}
%\renewcommand{\printmag}[4][grassilabel=magnificat-grassi]{
%\oldprintmag[#1]{#2}{#3}{#4}
%}

\setcounter{secnumdepth}{-1}

\def\mywidth{6in}
\def\myheight{9in}

\input{../inc_header}
\setlength\headheight{0.25in+15pt}
\setlength\headsep{1pc}
\setlength\topskip{0pc}
\setlength\footskip{1pc}
\geometry{outer=0.4in,inner=0.85in,top=0pc+\headheight+\headsep,bottom=0.4in,twoside=true}
\newpagestyle{main}{
\sethead[\garamond{\thepage}][\garamond{\chaptertitle}][] % even
{}{\garamond{\sectiontitle}}{\garamond{\thepage}} % odd
\setfoot[][][] % even
{}{}{} % odd
}
\pagestyle{main}


\titleformat
{\section} % command
[block] % shape
{\phantomsection\large\addfontfeature{Numbers=Lining}} % format
{} % label
{} % sep
{
    % \rule{\textwidth}{1pt}
    % \vspace{1ex}
    \centering
} % before-code
%[
% \vspace{-0.5ex}%
% \rule{\textwidth}{0.3pt}
%] % after-code
 
 
\titleformat{\chapter}[block]
{\thispagestyle{empty}\phantomsection\Large\scshape\addfontfeature{Numbers=Lining}}
{}{0.5em}{\centering}
 
\titlespacing{\chapter}{0pt}{6pt-\headheight}{1pc}
\titlespacing{\section}{0pt}{*2.5}{*1}
\titleclass{\chapter}{top}
\newcommand{\chapterbreak}{\clearpage}
%\titleclass{\section}{top}

\contentsmargin{2pc}
\dottedcontents{chapter}[2.3em]{}{2.3em}{1pc}
\dottedcontents{section}[5.5em]{}{3.2em}{1pc}

\newcommand{\printnote}[1]{
	{\normalsize \emph{#1}}
}
\newcommand{\subtitle}[1]{
\begin{center}{
	{\addfontfeature{Numbers=Lining} \normalsize \emph{#1}}
}\end{center}
}

\newcommand{\deusinadjutorium}{\noindent\printnote{\Vbar~\emph{Deus in adjutórium}, page \pageref{deusinadjutorium}.}}
\newcommand{\printcollect}[2]{
	\ifx\undefined\begincollectcols\def\begincollectcols{\begin{parcolumns}[rulebetween]{2}}\fi
	\ifx\printcollectheading\undefined\def\printcollectheading{T}\fi
	\if\printcollectheading T
	\needspace{3\baselineskip}
	\begin{center}{\large Collect.}\end{center}
	\vspace{-0.4\baselineskip}
	\fi
	\begincollectcols
	\sloppy
	\prayer{#1}{#2}
	\end{parcolumns}
	\let\begincollectcols=\undefined
}
\newcommand{\psalmcolsoverride}[1][0]{
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.45\linewidth}]{2}}
\ifnum#1=110
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.45\linewidth}]{2}}
\fi
\ifnum#1=111
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
\fi
\ifnum#1=129
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
\fi
\ifnum#1=131
\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
\fi
}
\newcommand{\printcommemoration}[2][.]{
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}
	\subtitle{\comheadingtext}
	\sectionmark{\comheadingtext}
	{
	\def\noeuouae{T}
	\printgabc{At Magn.}{\oldstylenums{\commagantlinetwo}}{\commagantinitial}{\commaganttex}
	}
	\translation[]{\englishcommagantiphon}

	\smallskip
	\ifx\commvlatin\undefined
		\printvr[\greseteolcustos{manual}]{\commvrtex}{\commvtranslation}{\commrtranslation}
	\else
		% TODO: change this to columns!
    \translation[\normalsize]{
	    \Vbar{}~\commvlatin{}%
	    \\
	    \emph{\Vbar{}~\commvtranslation{}}%

	    \smallskip

	    \Rbar{}~\commrlatin{}%
	    \\
	    \emph{\Rbar{}~\commrtranslation{}}%
	   }
	\fi

	\printcollect{\latincomcollect}{\englishcomcollect}
}
\newcommand{\printvespersmag}[2][.]{
	\grechangestaffsize{15}
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}

	\ifx\chaptertext\undefined\else{
		\oldneedspace{3\baselineskip}
		\printchapter{\chaptertext}{\chaptertranslation}
		\smallskip
	}\fi

	\ifx\printfullhymn\undefined
		\printhymnnote
	\else
		\printfullhymn
	\fi

	{
		\let\anttranslation=\englishmagantiphon
		\let\preverses=\premagverses
	    \let\preanttwo=\premagtwo
	    \let\preant=\premag
		\printmag{\magtone\magend}{\magantinitial}{\maganttex}
	}
	\vspace{-1\baselineskip}
	\oldneedspace{3\baselineskip}
	\printcollect{\latincollect}{\englishcollect}
}
\newcommand{\printvespers}[2][.]{
	\grechangestaffsize{15}
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}

	\deusinadjutorium{}
	\medskip
	\printpsalm{1}{\psalmonenum}{\psalmonetone\psalmoneend}{\antonetex}{\antoneinitial}
	\medskip
	\printpsalm{2}{\psalmtwonum}{\psalmtwotone\psalmtwoend}{\anttwotex}{\anttwoinitial}
	\medskip
	\needspace{3\baselineskip}
	\printpsalm{3}{\psalmthreenum}{\psalmthreetone\psalmthreeend}{\antthreetex}{\antthreeinitial}
	\medskip
	\needspace{3\baselineskip}
	\printpsalm{4}{\psalmfournum}{\psalmfourtone\psalmfourend}{\antfourtex}{\antfourinitial}
	\medskip
	\ifx\psalmfivenum\undefined{
		\ifx\antfivetex\undefined{%then it is a different antiphon for each
			\ifx\definevesperspropersalt\undefined\else{
				\definevesperspropersalt
				\ifx\vesperspropersaltnote\undefined\else
					\oldneedspace{3\baselineskip}
					\noindent\printnote{\vesperspropersaltnote}
				\fi
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
			\ifx\definevesperspropers\undefined\else{
				\definevesperspropers
				\ifx\vesperspropersnote\undefined\else
					\oldneedspace{3\baselineskip}
					\noindent\printnote{\vesperspropersnote}
				\fi
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
		}\else{%they share the same antiphon
			\ifx\definevesperspropersalt\undefined\else{
				\definevesperspropersalt
				\ifx\vesperspropersaltnote\undefined\else
					\def\prepsalmtitle{
						\smallskip
						\oldneedspace{3\baselineskip}
						\noindent\printnote{\vesperspropersaltnote}\vspace{-0.5\baselineskip}

					}
				\fi
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
			\def\onlyoneant{T}
			\ifx\definevesperspropers\undefined\else{
				\definevesperspropers
				\ifx\vesperspropersnote\undefined\else
					\oldneedspace{5\baselineskip}
					\noindent\printnote{\vesperspropersnote}\vspace{-0.5\baselineskip}
				\fi
				\def\prepsalmtitle{\def\onlyoneant{F}}
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
		}\fi
	}\else{
		\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
	}\fi
	%\medskip
	%\vspace{-\baselineskip}
	\needspace{3\baselineskip}
	\ifx\chapterreplacement\undefined{
		\ifx\chaptertext\undefined
			\def\printchapterheading{F}
		    \begin{center}{\large\textbf Chapter.}\end{center}

		    \vspace{-0.25\baselineskip plus 0.125\baselineskip}
			\ifx\definevesperspropersalt\undefined\else
			{
				\ifx\vesperspropersaltnote\undefined\else
					\printnote{\vesperspropersaltnote}
				\fi
				\definevesperspropersalt
				\printchapter{\chaptertext}{\chaptertranslation}
			}
			\medskip
			\fi
			\ifx\definevesperspropers\undefined\else
			{
				\ifx\vesperspropersnote\undefined\else
					\printnote{\vesperspropersnote}
				\fi
				\definevesperspropers
				\printchapter{\chaptertext}{\chaptertranslation}
			}
			\fi
		\else
			\vspace{-\baselineskip}
			\printchapter{\chaptertext}{\chaptertranslation}
		\fi
	}
	\else
	{\chapterreplacement}
	\fi

	\medskip
	\ifx\printfullhymn\undefined
		\ifx\printhymnnote\undefined\else
			\printhymnnote
			\medskip
		\fi
	\else
		\printfullhymn
		\medskip
	\fi
	\ifx\magreplacement\undefined
	{
		\ifx\definevesperspropersalt\undefined\else{
			{
			\ifx\definevesperspropers\undefined\else
				{
					\definevesperspropersalt
					\global\let\magtonealt=\magtone
					\global\let\magendalt=\magend
				}
				{
					\definevesperspropers
					\IfStrEq{\magtonealt\magendalt}{\magtone\magend}
					{\gdef\altmagsame{T}}
					{\gdef\altmagsame{F}}

				}
			\fi
			}
			\definevesperspropersalt
    		\needspace{12\baselineskip}
    		\hrule
		    \begin{center}{\large Magnificat.}\end{center}
	    	\vspace{-1ex}

	    	\ifx\vesperspropersaltnote\undefined\else
    		\needspace{10\baselineskip}
				\printnote{\vesperspropersaltnote\\\vspace{-0.5\baselineskip}}
			\fi
			\let\anttranslation=\maganttranslation
			\let\preverses=\premagverses
		    \let\preanttwo=\premagtwo
		    \let\preant=\premag
		    \def\nomagtitle{T}
		    \if\altmagsame T{
		    	\printgabc{At Magn.}{Ant. \magtone{}. \magend}{\magantinitial}{\maganttex}
		    	\translation[]{\anttranslation}
		    	\bigskip
		    }\else{
				\printmag{\magtone\magend}{\magantinitial}{\maganttex}
			}\fi
	    \hrule
	    \medskip
		}\fi
		\ifx\definevesperspropers\undefined\else
			\definevesperspropers
	    	\ifx\vesperspropersnote\undefined\else
	    		\needspace{10\baselineskip}
				\printnote{\vesperspropersnote\\\vspace{-0.5\baselineskip}}
			\fi
			\def\nomagtitle{T}
		\fi
		\let\anttranslation=\maganttranslation
		\let\preverses=\premagverses
	    \let\preanttwo=\premagtwo
	    \let\preant=\premag
		\printmag{\magtone\magend}{\magantinitial}{\maganttex}
		\global\let\altmagsame\undefined
		\global\let\magtonealt=\undefined
		\global\let\magendalt=\undefined
	}
	\else
	{\magreplacement}
	\fi
	{\ifx\postmag\undefined\else\postmag\fi}

	\vspace{-\baselineskip}
	\ifx\precollect\undefined\else\precollect\fi
	\ifx\collectreplacement\undefined{
		\ifx\collect\undefined
			\def\printcollectheading{F}
			\needspace{3\baselineskip}
			\begin{center}{\large Collect.}\end{center}

			\vspace{-0.5\baselineskip plus 0.25\baselineskip}
			\ifx\definevesperspropersalt\undefined\else
			{
				\ifx\vesperspropersaltnote\undefined\else
					\printnote{\vesperspropersaltnote}
				\fi
				\definevesperspropersalt
				\printcollect{\collect}{\collecttranslation}
			}
			\medskip
			\fi
			\ifx\definevesperspropers\undefined\else
			{
				\ifx\vesperspropersnote\undefined\else
					\printnote{\vesperspropersnote}
				\fi
				\definevesperspropers
				\printcollect{\collect}{\collecttranslation}
			}
			\fi
		\else
			\oldneedspace{5\baselineskip}
			\printcollect{\collect}{\collecttranslation}
		\fi
	}
	\else
	{\collectreplacement}
	\fi
	\medskip
}

\sloppy
\begin{document}
\normalsize
\grechangestaffsize{15}
%\pagenumbering{roman}
%\frontmatter

\tableofcontents

%\pagenumbering{arabic}
%\mainmatter

\chapter{Common of Festal Vespers}

%\subtitle{Festal Tone}
\label{deusinadjutorium}
\sectionmark{Deus in adjutórium}
\addcontentsline{toc}{section}{Deus in adjutórium}
\printnote{The Festal Tone may be sung on any Sunday or Feast.}
\printnote{From Septuagesima to Wednesday in Holy Week, the \emph{Laus tibi} is said instead of \emph{Allelúia}.}

\bigskip
\def\deusinadjutoriumsolemn{F}
\printdeusinadjutorium{}
\vfil

\pagebreak
%\subtitle{Solemn Tone}
\printnote{The Solemn Tone may only be sung on Feasts of the First or Second Class.}
\printnote{From Septuagesima to Wednesday in Holy Week, the \emph{Laus tibi} is said instead of \emph{Allelúia}.}

\bigskip
\def\deusinadjutoriumsolemn{T}
\printdeusinadjutorium{}


\printnote{Vespers then proceed with the Proper Antiphons, Psalms, Chapter, Hymn, Versicle,
Magnificat, and Collect given for the respective Sunday or Feast.}

\bigskip

\printnote{All Vespers conclude with the following:}
\\
\Vbar{} Dóminus vobíscum.\\%\hspace{5em}
\Rbar{} Et cum spíritu tuo.

\printnote{Or, in the absence of a priest or deacon:}
\\
\Vbar{} Dómine, exáudi oratiónem meam.\\
\Rbar{} Et clamor meus ad te véniat.

\bigskip

\def\noeuouae{T}
%\vfil
\input{inc-benedicamus-domino}

\def\dontrepeatantiphon{T}
\clearpage
%\input{inc-vespers-sunday}

%\input{inc-marian-anthems}

%\input{inc-advent}

% christmas through Holy Family
%\input{inc-christmas}

%\input{inc-timeafterepiphany}

%from shrovetide through passiontide
%\input{inc-lent}

%\input{inc-easter}

%\input{inc-pentecost}

%\chapter{Appendix}
%\input{inc-benediction}
%\input{inc-grassi}

\end{document}

