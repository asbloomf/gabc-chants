% !TEX TS-program = lualatex
% !TEX encoding = UTF-8

% This is a simple template for a LuaLaTeX document using gregorio scores.

% easter can be from march 22 to april 25

\usepackage{../definepsalms}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{titleps}
\usepackage{letltxmacro}
\usepackage{changepage} % gives us \ifoddpage use [strict]
\usepackage[super]{nth}
\usepackage[savepos]{zref}
\usepackage{xparse}
\usepackage{setspace}
\usepackage{amsfonts}
\usepackage{refcount}
\usepackage{metalogo}
\usepackage{enumitem}
\usepackage{svg}
%\nofiles
%\includeonly{inc-grassi}
\LetLtxMacro{\oldnth}{\nth}
\renewcommand{\nth}[1]{{\addfontfeature{Numbers=Lining}\oldnth{#1}}}
\LetLtxMacro{\oldneedspace}{\needspace}
\renewcommand{\needspace}[1]{
	\checkoddpage\ifoddpage\oldneedspace{#1}\else\fi
}
\let\gredagger=\dag
\newcommand*\cleartoleftpage{%
  \clearpage
  \ifodd\value{page}\hbox{}\newpage\fi
}
\hyphenation{GregoBase}

%\usepackage{hyperref}
\newcommand{\phantomsection}{}
\newcommand{\magnote}{
\IfStrEq{\anttone\nostarend}{8G}{\noindent\emph{A 3 part arrangement of the even verses by Grassi may be found on page \pageref{magnificat-grassi}.\\}}{}
% \IfStrEq{\anttone\nostarend}{1D}{\noindent\emph{A 4 part arrangement of the even verses by SMC may be found on page \pageref{magnificat-1D}.\\}}{}
% \IfStrEq{\anttone\nostarend}{1D2}{\noindent\emph{A 4 part arrangement of the even verses by SMC may be found on page \pageref{magnificat-1D}.\\}}{}
}
\ifthenelse{\boolean{includepolyphony}}{
	\presetkeys{mymag}{note=\magnote}{}
}{}
%\LetLtxMacro{\oldprintmag}{\printmag}
%\renewcommand{\printmag}[4][grassilabel=magnificat-grassi]{
%\oldprintmag[#1]{#2}{#3}{#4}
%}

\setcounter{secnumdepth}{-1}

\ifthenelse{\boolean{birmingham} \or \boolean{onlysundaycommon}}{
	%a4
	%\def\mywidth{210mm}
	%\def\myheight{297mm}
%
	%a5
	\def\mywidth{148mm}
	\def\myheight{210mm}
}{
	\ifthenelse{\boolean{lettersize}}{
		\def\mywidth{8.5in}
		\def\myheight{11in}
	}{
		\def\mywidth{6in}
		\def\myheight{9in}
	}
}

\input{../inc_header}
\gresetbarspacing{new}
%\gresetlastline{justified}
\setlength\headheight{0.25in+15pt}
\setlength\headsep{1pc}
\setlength\topskip{0pc}
\setlength\footskip{1pc}
\geometry{outer=0.4in,inner=0.85in,top=0pc+\headheight+\headsep,bottom=0.4in,twoside=true}
\newpagestyle{main}{
%\setheadrule{0pt}
\sethead[\garamond{\thepage}][\garamond{\chaptertitle}][] % even
{}{\garamond{\sectiontitle}}{\garamond{\thepage}} % odd
\setfoot[][][] % even
{}{}{} % odd
}
\pagestyle{main}

%\grechangeglyph{Porrectus*}{*}{.alt}
%\grechangeglyph{TorculusResupinus*}{*}{.alt}

\titleformat
{\section} % command
[block] % shape
{\phantomsection\large\addfontfeature{Numbers=Lining}} % format
{} % label
{} % sep
{
    % \rule{\textwidth}{1pt}
    % \vspace{1ex}
    \centering
} % before-code
%[
% \vspace{-0.5ex}%
% \rule{\textwidth}{0.3pt}
%] % after-code
 
 
\titleformat{\chapter}[block]
{\thispagestyle{empty}\phantomsection\Large\scshape\addfontfeature{Numbers=Lining}}
{}{0.5em}{\centering}
 
\titlespacing{\chapter}{0pt}{6pt-\headheight}{1pc}
\titlespacing{\section}{0pt}{*2.5}{*1}
\titleclass{\chapter}{top}
\newcommand{\chapterbreak}{\clearpage}
%\titleclass{\section}{top}

\contentsmargin{2pc}
%\dottedcontents{chapter}[2.3em]{}{2.3em}{1pc}
\titlecontents{chapter}[2.3em]{}{\contentslabel{2.3em}}{\hspace*{-2.3em}}{}
\dottedcontents{section}[5.5em]{}{3.2em}{1pc}

\newcommand{\printnote}[1]{
	{\normalsize \emph{#1}}
}
\newcommand{\subtitle}[1]{
{
	\centering
	{\addfontfeature{Numbers=Lining} \normalsize \emph{#1}}\par
}
}

\newcommand{\deusinadjutorium}[1][F]{\noindent\printnote{\Vbar~\emph{Deus in adjutórium}, p.~\pageref{deusinadjutorium}%
%if birmingham, both are on the same page so, it doesn't matter if it's solemn
\ifthenelse{\boolean{birmingham}\OR\pageref{deusinadjutorium}=\pageref{deusinadjutoriumsolemn}}{}{\if#1T or \pageref{deusinadjutoriumsolemn}\fi}.}}
%\newcommand{\deusinadjutoriumsolemn}{\noindent\printnote{\Vbar~\emph{Deus in adjutórium}, p.~\pageref{deusinadjutoriumsolemn}.}}
\newcommand{\printcollect}[2]{
	\ifx\undefined\begincollectcols\def\begincollectcols{\begin{parcolumns}[rulebetween]{2}}\fi
	\ifx\printcollectheading\undefined\def\printcollectheading{T}\fi
	\if\printcollectheading T
	\oldneedspace{3\baselineskip}
	\medskip
	{\centering\large Collect.\par}
	\smallskip
	\fi
	\begincollectcols
	\sloppy
	\prayer{#1}{#2}
	\end{parcolumns}
	\let\begincollectcols=\undefined
}
\newcommand{\benedicamusdominoreference}[1]{%
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		\Vbar~\emph{Benedicámus Dómino \IfInteger{#1}{#1}{\csname benedicamusdominoname#1\endcsname}}, page \pageref{benedicamusdomino-#1}.
	}{}
}
\newcommand{\benedicamusdominoreferencelentoreaster}{%
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		In Lent, \Vbar~\emph{Benedicámus Dómino \benedicamusdominonamelent}, page \pageref{benedicamusdomino-lent}, or in Easter, \emph{\benedicamusdominonameeaster}, page \pageref{benedicamusdomino-easter}.
	}{}
}
\newcommand{\benedicamusdominomaster}[1]{
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		\noindent\printnote{\benedicamusdominoreference{#1}}
		\ifx\postbenedicamusdomino\undefined\else\postbenedicamusdomino\fi
	}{}
	\bigskip
	\hrule
}
\newcommand{\benedicamusdominolentoreaster}{
	\ifthenelse{\boolean{includebenedicamusdominoreferences}}{
		\noindent\printnote{\benedicamusdominoreferencelentoreaster}
		\ifx\postbenedicamusdomino\undefined\else\postbenedicamusdomino\fi
	}{}
	\bigskip
	\hrule
}

\ifthenelse{\boolean{lettersize}}{
	\newcommand{\psalmcolsoverride}[1][0]{
	}	
}{
	\ifthenelse{\boolean{birmingham} \or \boolean{onlysundaycommon}}{
		\newcommand{\psalmcolsoverride}[1][0]{
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.44\linewidth}]{2}}
			\ifnum#1=110
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.454\linewidth}]{2}}
			\fi
			\ifnum#1=111
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth}]{2}}
			\fi
			\ifnum#1=112 % was blank so it was using 0.44
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.445\linewidth}]{2}}
			\fi
			\ifnum#1=113 % was blank so it was using 0.44
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth},distance=1.5em]{2}}
			\fi
			\ifnum#1=114 % was blank so it was using 0.44
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.46\linewidth}]{2}}
			\fi
			\ifnum#1=116
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.564\linewidth},distance=1.5em]{2}}
			\fi
			\ifnum#1=119
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.47\linewidth}]{2}}
			\fi
			\ifnum#1=120
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.47\linewidth}]{2}}
			\fi
			\ifnum#1=121
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
			\fi
			\ifnum#1=125
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.51\linewidth},distance=1.5em]{2}}
			\fi
			\ifnum#1=126
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth},distance=1.5em]{2}}
			\fi
			\ifnum#1=127
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
			\fi
			\ifnum#1=129
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.47\linewidth}]{2}}
			\fi
			\ifnum#1=131
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.487\linewidth},distance=1em]{2}}
			\fi
			\ifnum#1=137
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth},distance=1.5em]{2}}
			\fi
			\ifnum#1=138
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth},distance=1.5em]{2}}
			\fi
			\ifnum#1=147
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.48\linewidth},distance=1.5em]{2}}
			\fi
		}
	}{
		\newcommand{\psalmcolsoverride}[1][0]{
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.45\linewidth}]{2}}
			\ifnum#1=110
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth}]{2}}
			\fi
			\ifnum#1=111
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
			\fi
			%\ifnum#1=112
			%\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.445\linewidth}]{2}}
			%\fi
			\ifnum#1=116
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.5655\linewidth}]{2}}
			\fi
			\ifnum#1=121
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.47\linewidth}]{2}}
			\fi
			\ifnum#1=125
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.49\linewidth}]{2}}
			\fi
			\ifnum#1=129
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
			\fi
			\ifnum#1=131
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.4875\linewidth},distance=1em]{2}}
			\fi
			\ifnum#1=137
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween]{2}}
			\fi
			\ifnum#1=147
			%\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.465\linewidth}]{2}}
			\def\beginpsalmcols{\begin{parcolumns}[rulebetween,colwidths={1=0.475\linewidth}]{2}}
			\fi
		}
	}
}
\newcommand{\printvrcommem}{
		{\normalsize
		\ifx\beginvrcols\undefined\def\beginvrcols{\begin{parcolumns}[rulebetween]{2}}\fi
		\beginvrcols
		\colchunk{%
			\selectlanguage{latin}%
	    \Vbar{}~\commvlatin{}%
    }
		\colchunk{%
			\selectlanguage{american}%
	    \Vbar{}~\commvtranslation{}%
		}%
		\colplacechunks%
    \colchunk{%
			\selectlanguage{latin}%
	    \Rbar{}~\commrlatin{}%
		}%
		\colchunk{%
			\selectlanguage{american}%
	    \Rbar{}~\commrtranslation{}%
		}
		\end{parcolumns}
		}
}
\newcommand{\printvrdirigatur}{
	\smallskip{}
	\oldneedspace{3\baselineskip}
	\noindent\printnote{If the Sunday is being commemorated:\\}\vspace{-0.5\baselineskip}
	{
		\ifthenelse{\boolean{birmingham}}{
			\def\beginvrcols{\begin{parcolumns}[rulebetween,colwidths={1=0.53\linewidth}]{2}}
		}{
			\def\beginvrcols{\begin{parcolumns}[rulebetween,colwidths={1=0.51\linewidth}]{2}}
		}
		\def\commvlatin{Dirigátur Dómine orátio \textbf{mé}a.}
		\def\commrlatin{Sicut incénsum in conspéctu \textbf{tú}o.}
		\def\commvtranslation{\noindent{}Let my prayer be directed, O Lord.}
		\def\commrtranslation{\noindent{}As incense in Thy sight.}
		\printvrcommem{}
	}
}
\newcommand{\printvrmanenobiscum}{
	\smallskip{}
	\oldneedspace{3\baselineskip}
	\noindent\printnote{If the Sunday is being commemorated:\\}\vspace{-0.5\baselineskip}
	{
		\def\commvlatin{Mane nobíscum Dómine, alle\textbf{lú}ia.}
		\def\commrlatin{Quóniam advesperáscit, alle\textbf{lú}ia.}
		\def\commvtranslation{Stay with us O Lord, alleluia.}
		\def\commrtranslation{Because it is towards evening, alleluia.}
		\printvrcommem{}
	}
}
\newcommand{\printvrdominusincaelo}{
	\smallskip{}
	\oldneedspace{3\baselineskip}
	\noindent\printnote{If the Sunday is being commemorated:\\}\vspace{-0.5\baselineskip}
	{
		\def\commvlatin{Dóminus in cælo, alle\textbf{lú}ia.}
		\def\commrlatin{Parávit sedem suam, alle\textbf{lú}ia.}
		\def\commvtranslation{The Lord in heaven, alleluia.}
		\def\commrtranslation{Has prepared His throne, alleluia.}
		\printvrcommem{}
	}
}
\newcommand{\printcommemoration}[2][.]{
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}
	\subtitle{\comheadingtext}
	\sectionmark{\comheadingtext}
	{
	\def\noeuouae{F}
	%\printgabc{At Magn.}{\oldstylenums{\commagantlinetwo}}{\commagantinitial}{\commaganttex}
		{%
			\gresetinitiallines{0}
			\ifx\gabcfolder\undefined
		        \gregorioscore{\commaganttex}
		    \else
		        \gregorioscore{\gabcfolder/\commaganttex}
		    \fi

			\greseteolcustos{auto}%
		}
	}
	\translation[]{\englishcommagantiphon}

	\smallskip
	\ifx\commvlatin\undefined
		\printvr[\greseteolcustos{manual}]{\commvrtex}{\commvtranslation}{\commrtranslation}
			\greseteolcustos{auto}
	\else
	{
		\oldneedspace{3\baselineskip}
		\printvrcommem{}
	}
	\fi

	\printcollect{\latincomcollect}{\englishcomcollect}
}
\DeclareDocumentCommand{\printbothversions}{ O{\undefined} O{\undefined} m m }{
% #1 & #2 are the label
% #3 is what to check for
% #4 is the body of what to print
	\ifx#3\undefined
		\ifx\definevesperspropersalt\undefined\else
	  {
			\ifx\vesperspropersaltnote\undefined\else
		    \oldneedspace{3\baselineskip}
				\printnote{\vesperspropersaltnote}
			\fi
			\definevesperspropersalt
			\ifx#2\undefined\else\oldneedspace{5\baselineskip}\label{#2}\fi
	  	#4
		}
		\medskip
		\fi
		\ifx\definevesperspropers\undefined\else
	  {
			\ifx\vesperspropersnote\undefined\else
	    	\oldneedspace{3\baselineskip}
				\printnote{\vesperspropersnote}
			\fi
			\definevesperspropers
			\ifx#1\undefined\else\oldneedspace{5\baselineskip}\label{#1}\fi
	  	#4
		}
		\fi
	\else
  {
		\ifx#1\undefined\else\label{#1}\fi
  	#4
	}
	\fi
}
\newcommand{\printvespersmag}[2][.]{
	\grechangestaffsize{15}
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}
	\ifx\prevespers\undefined\else\prevespers\fi

	\ifx\chaptertext\undefined\else{
		\oldneedspace{3\baselineskip}
		\printchapter{\chaptertext}{\chaptertranslation}
		\smallskip
	}\fi

	\ifx\printfullhymn\undefined
		\ifx\printhymnnote\undefined
			%print the hymn
			\ifx\hymninput\undefined\else
				\input{\hymninput}
			\fi
			\printbothversions{\hymntex}{\printhymn[\hymnlabel]{\oldstylenums{\hymnlinetwo}}{\hymninitial}{\hymntex}{\hymntranslation}}
			\printbothversions[\vrlabel][\vraltlabel]{\vrtex}{%
		    \ifx\vrlinebreak\undefined\def\vrlinebreak{T}\fi
		    \printvr[\greseteolcustos{manual}]{\vrtex}{\vtranslation}{\rtranslation}
		    \greseteolcustos{auto}
			}
		\else
			\printhymnnote
		\fi
	\else
		\printfullhymn
	\fi

	{
		\ifx\premagnificat\undefined\else\premagnificat\fi
		\let\anttranslation=\englishmagantiphon
		\let\preverses=\premagverses
	    \let\preanttwo=\premagtwo
	    \let\preant=\premag
	  \oldneedspace{3\baselineskip}
		\printmag{\magtone\magend}{\magantinitial}{\maganttex}
	}
	\ifx\precollect\undefined\vspace{-1\baselineskip}\else\precollect\fi
	\oldneedspace{3\baselineskip}
	\printcollect{\latincollect}{\englishcollect}
}
\newcommand{\printpsalms}{
	\printpsalm{1}{\psalmonenum}{\psalmonetone\psalmoneend}{\antonetex}{\antoneinitial}
	\medskip
	\needspace{3\baselineskip}
	\printpsalm{2}{\psalmtwonum}{\psalmtwotone\psalmtwoend}{\anttwotex}{\anttwoinitial}
	\medskip
	\needspace{3\baselineskip}
	\printpsalm{3}{\psalmthreenum}{\psalmthreetone\psalmthreeend}{\antthreetex}{\antthreeinitial}
	\medskip
	\needspace{3\baselineskip}
	\printpsalm{4}{\psalmfournum}{\psalmfourtone\psalmfourend}{\antfourtex}{\antfourinitial}
	\medskip
	\ifx\psalmfivenum\undefined{
		\ifx\antfivetex\undefined{%then it is a different antiphon for each
			\ifx\definevesperspropersalt\undefined\else{
				\definevesperspropersalt
				\ifx\vesperspropersaltnote\undefined\else
					\oldneedspace{3\baselineskip}
					\noindent\printnote{\vesperspropersaltnote}
				\fi
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
			\ifx\definevesperspropers\undefined\else{
				\definevesperspropers
				\ifx\vesperspropersnote\undefined\else
					\oldneedspace{3\baselineskip}
					\noindent\printnote{\vesperspropersnote}
				\fi
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
		}\else{%they share the same antiphon
			\ifx\definevesperspropersalt\undefined\else{
				\definevesperspropersalt
				\ifx\vesperspropersaltnote\undefined\else
					\let\oldprepsalmtitle=\prepsalmtitlefive
					\def\prepsalmtitlefive{
						\smallskip
						\oldneedspace{3\baselineskip}
						\noindent\printnote{\vesperspropersaltnote}

						\ifx\oldprepsalmtitle\undefined\else\oldprepsalmtitle\fi
					}
				\fi
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
			\def\onlyoneant{T}
			\ifx\definevesperspropers\undefined\else{
				\definevesperspropers
				\ifx\vesperspropersnote\undefined\else
					\oldneedspace{3\baselineskip}
					\noindent\printnote{\vesperspropersnote}
				\fi
				\let\oldprepsalmtitle=\prepsalmtitlefive
				\def\prepsalmtitlefive{\def\onlyoneant{F}\ifx\oldprepsalmtitle\undefined\else\oldprepsalmtitle\fi}
				\def\printrepeatantiphon{T}
				\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
			}\fi
		}\fi
	}\else{
		\printpsalm{5}{\psalmfivenum}{\psalmfivetone\psalmfiveend}{\antfivetex}{\antfiveinitial}
	}\fi
}
\newcommand{\printvespers}[2][.]{
	\grechangestaffsize{15}
	\def\gabcfolder{#1}
	\input{\gabcfolder/#2}
	\ifx\prevespers\undefined\else%
	\prevespers{}
	\fi

	\ifthenelse{\boolean{onlysundaycommon}}{}{% false
		\ifx\deusinadjutoriumsolemn\undefined\def\deusinadjutoriumsolemn{F}\fi
		\deusinadjutorium[\deusinadjutoriumsolemn]

		\ifx\postdeusinadjutorium\undefined\else\postdeusinadjutorium\fi
		\medskip
	}
	\ifx\psalmsreplacement\undefined{
		\ifx\psalmonenum\undefined{
			\ifx\definevesperspropersalt\undefined\else{
				\definevesperspropersalt
				\ifx\prevesperspsalmsalt\undefined\else\prevesperspsalmsalt{}\fi
				\ifx\vesperspropersaltnote\undefined\else
					\oldneedspace{3\baselineskip}
					\noindent\printnote{\vesperspropersaltnote}
				\fi
				\ifx\vesperspsalmsaltlabel\undefined\else\vesperspsalmsaltlabel{}\fi
				\printpsalms{}
			}\fi
			\ifx\definevesperspropers\undefined\else{
				\definevesperspropers
				\ifx\prevesperspsalms\undefined\else\prevesperspsalms{}\fi
				\ifx\vesperspropersnote\undefined\else
					\oldneedspace{3\baselineskip}
					\noindent\printnote{\vesperspropersnote}
				\fi
				\ifx\vesperspsalmslabel\undefined\else\vesperspsalmslabel{}\fi
				\printpsalms{}
			}\fi
		}\else
			\printpsalms{}
		\fi
	}\else{
		\psalmsreplacement{}
	}\fi
	%\medskip
	%\vspace{-\baselineskip}
	%\needspace{3\baselineskip}
	\ifx\chapterreplacement\undefined{
		\ifx\chaptertext\undefined
			\ifx\prechapter\undefined\else\prechapter\fi
			\def\printchapterheading{F}
	    \begin{center}{\large\textbf Chapter.}\end{center}
	    \vspace{-0.3\baselineskip}
			\ifx\definevesperspropersalt\undefined\else
			{
				\ifx\vesperspropersaltnote\undefined\else
					\oldneedspace{\baselineskip}
					\printnote{\vesperspropersaltnote}
				\fi
				\definevesperspropersalt
				\printchapter{\chaptertext}{\chaptertranslation}
			}
			\medskip
			\fi
			\ifx\definevesperspropers\undefined\else
			{
				\ifx\vesperspropersnote\undefined\else
					\oldneedspace{3\baselineskip}
					\printnote{\vesperspropersnote}
				\fi
				\definevesperspropers
				\printchapter{\chaptertext}{\chaptertranslation}
			}
			\fi
		\else
			%\vspace{-\baselineskip}
			\oldneedspace{24pt}
			\ifx\prechapter\undefined\else\prechapter\fi
			\printchapter{\chaptertext}{\chaptertranslation}
		\fi
	}
	\else
	{\chapterreplacement}
	\fi

	\medskip
	\ifx\printfullhymn\undefined
		\ifx\printhymnnote\undefined
			\ifx\hymninput\undefined\else
				\input{\hymninput}
			\fi
			% \ifx\prehymn\undefined\else
			% 	\prehymn
			% \fi
			\printbothversions{\hymntex}{\printhymn[\hymnlabel]{\oldstylenums{\hymnlinetwo}}{\hymninitial}{\hymntex}{\hymntranslation}}
		\else
			\printhymnnote
		\fi
		\ifx\prevr\undefined\else\prevr\fi
		\printbothversions[\vrlabel][\vraltlabel]{\vrtex}{%
	    \ifx\vrlinebreak\undefined\def\vrlinebreak{T}\fi
	    \printvr[\if\vrlinebreak T\greseteolcustos{manual}\fi]{\vrtex}{\vtranslation}{\rtranslation}
	    \greseteolcustos{auto}
		}
		\ifx\postvr\undefined\else\postvr\fi
		\ifx\vrpttex\undefined\else%
			\smallskip
			\noindent
			\printnote{In Paschaltide:}
			\ifx\vrlinebreak\undefined\def\vrlinebreak{T}\fi
			\if\vrlinebreak T\greseteolcustos{manual}\fi
			\gresetinitiallines{0}
			\gregorioscore{\gabcfolder/\vrpttex}
			\greseteolcustos{auto}
		\fi
	\else
		\printfullhymn
	\fi

	\medskip

	\ifx\magreplacement\undefined
	{
		\ifx\maganttex\undefined
		\ifx\definevesperspropersalt\undefined\else{
			{
			\ifx\definevesperspropers\undefined\else
				{
					\definevesperspropersalt
					\global\let\magtonealt=\magtone
					\global\let\magendalt=\magend
				}
				{
					\definevesperspropers
					\IfStrEq{\magtonealt\magendalt}{\magtone\magend}
					{\gdef\altmagsame{T}}
					{\gdef\altmagsame{F}}

				}
			\fi
			}
			\definevesperspropersalt
	  		\hrule
	  		\needspace{7\baselineskip}
				\ifx\premagnificat\undefined\else\premagnificat\fi
		    \ifx\premagtitle\undefined\else\premagtitle\fi
		    \begin{center}{\large Magnificat.}\end{center}
	    	\vspace{-1ex}
	    	\ifx\postmagtitle\undefined\else\postmagtitle\fi

	    	\ifx\vesperspropersaltnote\undefined\else
	    		\oldneedspace{2\baselineskip}
	    		\ifx\premagnificat\undefined\else\premagnificat\fi
				\printnote{\vesperspropersaltnote\par}
			\fi
			\let\anttranslation=\maganttranslation
			\let\preverses=\premagverses
		    \let\preanttwo=\premagtwo
		    \let\preant=\premag
		    \def\nomagtitle{T}
		    \if\altmagsame T{
		    	\printgabc{At Magn.}{Ant.~\magtone{}.~\magend}{\magantinitial}{\maganttex}
		    	\translation[]{\anttranslation}
		    	\bigskip
		    }\else{
				\printmag{\magtone\magend}{\magantinitial}{\maganttex}
			}\fi
		    \hrule
		    \medskip
		}\fi
		\ifx\definevesperspropers\undefined\else
			\definevesperspropers
	    	\ifx\vesperspropersnote\undefined\else
	    		\needspace{6\baselineskip}
	    		\oldneedspace{4\baselineskip}
	    		\ifx\premagnificat\undefined\else\premagnificat\fi
				\printnote{\vesperspropersnote\par}
			\fi
			\def\nomagtitle{T}
		\fi
		\else\ifx\premagnificat\undefined\else\premagnificat\fi
		\fi
		\let\anttranslation=\maganttranslation
		\let\preverses=\premagverses
	    \let\preanttwo=\premagtwo
	    \let\preant=\premag
		\printmag{\magtone\magend}{\magantinitial}{\maganttex}
		\global\let\altmagsame\undefined
		\global\let\magtonealt=\undefined
		\global\let\magendalt=\undefined
	}
	\else
	{\magreplacement}
	\fi
	{\ifx\postmag\undefined\else\postmag\fi}

	\vspace{-\baselineskip}
%	\ifx\precollect\undefined\else\precollect\fi
	\ifx\collectreplacement\undefined{
		\ifx\collect\undefined
			\def\printcollectheading{F}
			\needspace{3\baselineskip}
			\ifx\precollect\undefined\else\precollect\fi
			\begin{center}{\large Collect.}\end{center}

			\vspace{-0.5\baselineskip plus 0.25\baselineskip}
			\ifx\definevesperspropersalt\undefined\else
			{
				\ifx\vesperspropersaltnote\undefined\else
					\printnote{\vesperspropersaltnote}
				\fi
				\definevesperspropersalt
				\printcollect{\collect}{\collecttranslation}
			}
			\medskip
			\fi
			\ifx\definevesperspropers\undefined\else
			{
				\ifx\vesperspropersnote\undefined\else
					\printnote{\vesperspropersnote}
				\fi
				\definevesperspropers
				\printcollect{\collect}{\collecttranslation}
			}
			\fi
		\else
			\oldneedspace{3\baselineskip}
			\needspace{5\baselineskip}
			\ifx\precollect\undefined\else\precollect\fi
			\printcollect{\collect}{\collecttranslation}
		\fi
	}
	\else
	{\collectreplacement}
	\fi
	\medskip
}

\sloppy
%\nofiles
\begin{document}
\normalsize
\grechangestaffsize{15}
{
	\thispagestyle{empty}
	% title page
	\ifthenelse{\boolean{birmingham}}{% birmingham
		{\centering

		\vspace*{0pt plus 0.75 fill}

		\uppercase{
		{\large
		Vesperale

		\medskip

		Pro Dominicis et Festis

		}}

		\vfill
		\begin{centering}

		\noindent\includegraphics[width=\textwidth]{SPNcrest.png}

		\end{centering}
		\vfill

		ad usum Oratorii Sancti Philippi Nerii

		\vfill}
	}{%
		\ifthenelse{\boolean{stlouis}}{%
			\vspace*{5\baselineskip}

			{\centering

			{\Huge
			Vespers with Gregorian Chant

			}

			{\Large\medskip
			\emph{for}

			\medskip}

			{\Huge
			Sundays\ifthenelse{\boolean{onlysundaycommon}}{}{ \& Holy Days}

			}
			\vfill\vfill

			\includesvg[width=0.75\linewidth]{SsGregoryAndAugustineMark+Text_Logo_Black}%SsGregoryAndAugustineFullLogo_Black

			%\vspace*{5\baselineskip}
			}

		}{% general
			\vspace*{5\baselineskip}

			{\centering

			{\Huge
			Vespers with Gregorian Chant

			}

			{\Large\medskip
			\emph{for}

			\medskip}

			{\Huge
			Sundays\ifthenelse{\boolean{onlysundaycommon}}{}{ \& Holy Days}

			}
			\vfill}
		}
	}
	\pagebreak
	% copyright page
	\thispagestyle{empty}
	\ifthenelse{\boolean{birmingham}}{
		\noindent{}Vesperale pro dominicis et festis ad usum Oratorii Sancti Philippi Nerii apud Birminghamiensem: \emph{newly typeset, based on \emph{The Liber Usualis}, edited by the Benedictines of Solesmes (Desclee Company, 1961).}
	}{
		\noindent{}Vespers with Gregorian Chant for Sundays\ifthenelse{\boolean{onlysundaycommon}}{}{ \& Holy Days}: \emph{newly typeset, based on \emph{The Liber Usualis}, edited by the Benedictines of Solesmes (Desclee Company, 1961).}
	}

	\bigskip{}\noindent{}Many thanks to Elie Roux for creating Gregorio, to all the people answering questions on the Gregorio forums, to Olivier Berton for creating GregoBase (http://gregobase.selapa.net) which makes it much easier to find all the chant that Andrew Hinkley and others have contributed to the public domain.  Also many thanks to my brother Benjamin, whose website (http://bbloomf.github.io/jgabc) makes it incredibly easy to typeset the psalms and substantially easier than otherwise to typeset Gregorian chant with Gregorio.

	\ifthenelse{\boolean{stlouis}}{}{
	\bigskip\noindent{}January 2021.

	\noindent{}Note that the 4A* and 8G* endings are optional.  If you do not wish to employ the optional ending, just treat it like 4A or 8G by simply ending on the penultimate note, that is, the LA for 4A or the SOL for 8G.
	}

	\begin{flushright}
	\emph{Albert Bloomfield}\\
	Cincinnati, Ohio
	\end{flushright}

	\bigskip{}\noindent{}http://asbloomf.github.io/gabc-chants

	\vfill
%editions
	\bigskip{}\noindent{}%
	\ifthenelse{\boolean{stlouis}}{%
		The Oratory of Ss.~Gregory \& Augustine edition, December 2020

		\bigskip{}
	}{%
		\ifthenelse{\boolean{birmingham}}%
		{% true
			Birmingham edition, February 2019.

			\bigskip{}
		}{% false
		  \ifthenelse{\boolean{onlysundaycommon}}{
		  		Simple edition, 1 July 2020.

		  		\bigskip{}
		  	}{%false
				First edition, 3 December 2015.

				\hangindent=1em % indent all subsequent lines
				\noindent{}Second edition, 15 August 2016.

			    \noindent{}Third edition, 6 December 2016.

			    \noindent{}Fourth edition, 28 January 2017.

			    \noindent{}Fifth edition, 15 October 2017.

			    \noindent{}Sixth edition, 17 March 2021.

			    \bigskip
		   	}
	    }
    }

\makeatletter
	\noindent{}Typeset using \LuaLaTeX{}\ifthenelse{\boolean{includepolyphony}}{, Lilypond version 2.20.0,}{} and Gregorio version \gre@gregoriotexversion{}
\makeatother

	\bigskip{}\noindent{}This work is free of known copyright restrictions.

	\bigskip{}\noindent{}%CreateSpace
	ISBN: \isbn{}
	%
  %\noindent{}Lulu ISBN: 978-1-329-59990-1
}
%\frontmatter
%\pagenumbering{roman}

\ifthenelse{\boolean{onlysundaycommon}}{}{%
\tableofcontents%
}

%\pagenumbering{arabic}
%\mainmatter

\ifthenelse{\boolean{testrun}}{
	%\input{inc-marian-anthems-appendix}
}{
\include{inc-common-vespers}
\ifthenelse{\boolean{birmingham} \or \boolean{onlysundaycommon}}{}{% false
	\include{inc-benedicamus-domino}

	\include{inc-marian-anthems}

	\clearpage
}

\input{inc-vespers-sunday}

\ifthenelse{\boolean{birmingham}}{% true
	\grechangeglyph{Porrectus*}{*}{.alt} % this is really just for september 14 as far as I know

	%\cleartoleftpage
	\input{inc-benedicamus-domino}

	\cleartoleftpage
	\include{inc-marian-anthems}

	\clearpage
}{}
\ifthenelse{\boolean{onlysundaycommon}}{% true
	\input{inc-benedicamus-domino}

	{
	  \let\rlatin\undefined
	  \let\rtranslation\undefined
	  \def\vlatin{Fidélium ánimæ per misericórdiam Dei requiéscant in pace.\\\Rbar~Amen.}
	  %\def\rlatin{Amen.}
	  \def\vtranslation{May the souls of the faithful departed through the mercy of God rest in peace.\hfill\Rbar~Amen.}
	  %\def\rtranslation{Amen.}
	  \printvrwithtranslation{}
	  \bigskip
	}

	\clearpage
}{}

\ifthenelse{\boolean{testrun} \or \boolean{onlysundaycommon}}{}{
	\include{inc-advent}

	%christmas through Holy Family
	\include{inc-christmas}

	\include{inc-timeafterepiphany}

	%from Septuagesima through passiontide
	\include{inc-lent}

	\include{inc-easter}
	\include{inc-timeaftereaster}

	\include{inc-pentecost}

	\include{inc-timeafterpentecost}

	\include{inc-proper-of-saints}
}

\ifthenelse{\boolean{includeappendix}}{
	\cleardoublepage	
	\chapter{Appendix}
	\ifthenelse{\boolean{includecommonofdedicationofchurch}}{
		\input{inc-commondedicationofchurch}
	}{}
	\ifthenelse{\boolean{includevespersofdead}}{
		\input{inc-vespersofdead}
	}{}
	\input{inc-40hours}
	\ifthenelse{\boolean{includebenediction}}{
		\input{inc-benediction}
	}{}
	\ifthenelse{\boolean{includepolyphony}}{
		\cleartoleftpage{}
		\input{inc-lucis_creator_poly}
		\input{inc-marian-anthems-appendix}
		\include{inc-mag1D}
		\include{inc-mag7a}
		\include{inc-grassi}
	}{}
}{
	\ifthenelse{\boolean{includevespersofdead}}{
		\cleardoublepage
		\chapter{Appendix}
		\ifthenelse{\boolean{includecommonofdedicationofchurch}}{
			\input{inc-commondedicationofchurch}
		}{}
		\input{inc-vespersofdead}
	}{}
}
\ifthenelse{\boolean{onlysundaycommon}}{% true
	\input{inc-benediction}

	%\cleartoleftpage
	\include{inc-marian-anthems}
}{}
}
\end{document}

